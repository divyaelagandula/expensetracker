<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    #premium{
        background-color: green;
        height: 30px;
       
    }
</style>
<body>
    <button id="premium">By Premium Membership</button>
    <button style='display: none;' id="leadership">ShowLeaderBoard</button>
    <p id="memeber"></p>
    <form>
    
        <label for="amount">Enter amount</label>
        <input type="number" id="amount">
        <label for="description">Enter description</label>
        <input type="text" id="description">
        <label for="category">Choose a category</label>
        <select name="category" id="category">
            <option value="restaurent">restaurent</option>
            <option value="movie">movie</option>
            <option value="groceries">groceries</option>
            <option value="shopping">shopping</option>

        </select><br><br>
        <button type="submit">add expense</button>
    </form>
     <ul id="expense-details"></ul>
     <h2 style="display: none;" id="leaderBoard">Leader Board</h2>
     <ul id="userstotalamount"></ul>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
    document.addEventListener('DOMContentLoaded',()=>{
        resetform()
        getexpenseDetails()
        checkingUserPremiumOrNot()
    })
    function resetform(){
  
    document.getElementById('amount').value=''
    document.getElementById('description').value=''
        document.getElementById('category').value=''

    }
    const form=document.querySelector('form')
    form.addEventListener('submit',async (event)=>{
        try{ 
            event.preventDefault()
            
                const token=localStorage.getItem('token')
             console.log('local storage tocken .....',token)
            const amount=document.getElementById('amount').value
            const description =document.getElementById('description').value
            const category=document.getElementById('category').value
            const obj={amount,description,category}
            const result=await axios.post('http://localhost:3000/expense/addexpense',obj,{headers:{'authorization':token}})
            console.log(result)
            alert(result.data.message)
            resetform()
            getexpenseDetails()
            

        }
        catch(err){
            console.log(err)
            if(err.status==400){
                alert(err.message)
            }
        }

    })
    async function getexpenseDetails(){
        
        try{
            const token=localStorage.getItem('token')

               console.log('local storage tocken .....',token)
            const result= await axios.get('http://localhost:3000/expense/getexpenses',{headers:{'authorization':token}})
            const expenses=result.data
            const ul=document.querySelector('ul')
            ul.innerHTML=''
            for(const expense of expenses){
                const li=document.createElement('li')
                li.innerHTML=`${expense.amount}-${expense.description}-${expense.category}`
                const button=document.createElement('button')
                button.textContent='Delete expense'
                button.onclick=()=>{
                    deleteExpense(expense.id)
                }
                li.appendChild(button)
                ul.appendChild(li)

            }

        }
        catch(err){
            console.log(err)
        }

    }
async function deleteExpense(id){
    try{
        const token=localStorage.getItem('token')
        const result=await axios.delete(`http://localhost:3000/expense/deleteexpense/${id}`,{headers:{'authorization':token}})
        console.log(result)
        alert(result.data.message)
        getexpenseDetails()

    }
    catch(err){
        console.log(err)
    }
}
   const cashfree = Cashfree({
        mode: "sandbox",
      });

const premium=document.getElementById('premium')
premium.addEventListener('click',async ()=>{
      try {
        const response=await axios.post('http://localhost:3000/membership/pay')
       
        

       
        const paymentSessionId = response.data.paymentSessionId;
        const orderId = response.data.orderId;
        console.log(paymentSessionId,orderId)

        // Initialize checkout options
        let checkoutOptions = {
            paymentSessionId: paymentSessionId,
          
          //? Modal payment options
             redirectTarget: "_modal",
        };

        // Start the checkout process
        const result = await cashfree.checkout(checkoutOptions);

        if(result.error){
            // This will be true whenever user clicks on close icon inside the modal or any error happens during the payment
            console.log("User has closed the popup or there is some payment error, Check for Payment Status");
            console.log(result.error);
        }
        if(result.redirect){
            // This will be true when the payment redirection page couldn't be opened in the same window
            // This is an exceptional case only when the page is opened inside an inAppBrowser
            // In this case the customer will be redirected to return url once payment is completed
            console.log("Payment will be redirected");
        }
        if(result.paymentDetails){
            // This will be called whenever the payment is completed irrespective of transaction status
            console.log("Payment has been completed, Check for Payment Status");
            console.log(result.paymentDetails.paymentMessage);
            const token=localStorage.getItem('token')
           
const response= await axios.get(`http://localhost:3000/membership/payment-status/${orderId}`,{headers:{'authorization':token}})

           
            alert("Your payment is " + response.data.orderStatus)
           checkingUserPremiumOrNot()
        }


      } catch (err) {
        console.error("Error:", err);
      }
    
})
async function checkingUserPremiumOrNot(){
    try{
          const token=localStorage.getItem('token')
    const result= await axios.get('http://localhost:3000/premium/checking',{headers:{'authorization':token}})
    console.log(result.data.userResult)
    if(result.data.userResult.membershipStatus==='true'){
        const leadership=document.getElementById('leadership')
                leadership.style.display='block'
                const premium=document.getElementById('premium')
                premium.style.display='none'
                const para=document.getElementById('memeber')
                para.style.color='red'
                para.textContent='Your a premium memeber'
                leadership.addEventListener('click',()=>{
                    accesendingOrderExpenses()
                })
        }
    }
    catch(err){
        console.log(err)
    }
   
}
async function accesendingOrderExpenses(){
    try{
    const result=await axios.get('http://localhost:3000/premium/leaderBoard')
    console.log(result.data.userexpenses)
    const users_amount=result.data.userexpenses
    const heading=document.getElementById('leaderBoard')
    heading.style.display='block'
    const ul=document.getElementById('userstotalamount')
    ul.textContent=''
    for(let useramount of users_amount){
        const li=document.createElement('li')
        li.innerHTML=`NAME - ${useramount.name},Total Expense -${useramount.total_amount}`
        ul.appendChild(li)
    }
    
    }
    catch(err){
        console.log(err)
    }




}

</script>
</html>