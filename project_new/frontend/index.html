<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #open_form_table {
            padding: 10px 20px;
            font-size: 10px;
            background-color: orangered;
            color: white;
            border: 2px solid black;

        }
        #table-creation-form{
            display: none;
            padding: 20px;
            width: 50%;
            margin: auto;
            height: auto;
            background-color: thistle;
            position: relative;
        }
        .close-button{
            position: absolute;
            top:5px;
            right: 5px;
            
        }
        .input-group input{
            width: 50%;
            padding: 10px;
            margin-top: 5px;
        }
        .headings{
            display: flex;
            flex-direction: row;
            font-weight: bold;
            margin-top: 5px;
        }
        .headings div{
            flex: 1;
        }
       
        .column-input{
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-top: 5px;
        }
        .column-input input, .column-input select{
            flex: 1;
        }
        #add-column-button{
             background: none;
    border: none;
    padding: 0;
    color: #007bff; 
    text-decoration: underline;
    cursor: pointer;
        }
    .fetchedtablename{
        cursor: pointer;
        color: blue;
    }
    #left-sidebar{
        width:20%;
        height:100vh;
        float:left;
        border-right:2px solid black;
        padding:10px;
        box-sizing: border-box;
    }
    #right-content{
        width:80%;
        height:100vh;
        float:right;
        padding:10px;
        box-sizing: border-box;
        position: relative;
    }
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 8px;
        text-align: left;
        background-color: lightgrey;
    }
    table {
        width: 100%;
        margin-top: 20px;
    }
    #insert-data-button{
        position: absolute;
        top:10px;
        right:10px;
        padding: 10px 20px;
        font-size: 10px;
        background-color: orangered;
        color: white;
        border: 2px solid black;
        display: none;
    }



    </style>
</head>
<body>
    <div id="left-sidebar">
        <div id="tables">
            <ul id="table-list"></ul>

        </div>
        <button id="open_form_table" onclick="togglefunction(true)">+create table</button>

    </div>
    <div id="right-content">
        <button id="insert-data-button" onclick="showform(true)">Insert Data</button>
        <div id="table-colums-display">
            <table class="table">
                <thead id="table-head" >
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>   
        <div id="table-creation-form">  

            <button class="close-button" onclick="togglefunction(false)">X</button>
            <h1>Create New Table</h1>
            <div class="input-group">
                <label for="table-name">Table Name:</label><br>
                <input type="text" id="table-name" name="table-name" placeholder="Enter table name">
            </div>
            <div class="headings">
                <div>Column Name</div>
                <div>Data Type</div>
            </div>
            <div id="columns">
                <div class="column-input">
                    <input type="text" placeholder="Column Name">
                    <select>
                        <option value="INTEGER">INTEGER</option>
                        <option value="STRING">STRING</option>
                        <option value="DATE">DATE</option>
                        <option value="BOOLEAN">BOOLEAN</option>
                    </select>
                </div>
            </div>
            <button id="add-column-button" onclick="addColumn()">add another field</button>
            <br><br>
            <button id="create-table-button" onclick="createTable()">Create Table</button>


        </div>
        <form id="inserting-data-into-db" style="display: none;">
            <h1>Add Record</h1>
            <div class="form_input-group">

            </div>
            
            <button type="submit">Insert Record</button>
        </form>
  


    </div>
    
   
   <script>

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('table-creation-form').style.display = 'none';
        document.getElementById('open_form_table').style.display = 'block';
        resetForm();
        gettables();
    
     
    });
    function togglefunction(show){
        const form = document.getElementById('table-creation-form');
        const openButton = document.getElementById('open_form_table');
        const message = document.getElementById('table-creation-message');

        if(show){
            form.style.display="block";
            openButton.style.display="none"; 

        }else{
            form.style.display="none";  
            openButton.style.display="block"; 
            resetForm();
    }
}
    function resetForm() {
       document.getElementById('table-name').value = '';
         const columnsDiv = document.getElementById('columns');
         columnsDiv.innerHTML = '';
    }
    function addColumn(){
        const columnsDiv = document.getElementById('columns');
        const newColumnDiv = document.createElement('div');
        newColumnDiv.className = 'column-input';
        newColumnDiv.innerHTML = `
            <input type="text" placeholder="Column Name">
            <select>
                <option value="INTEGER">INTEGER</option>
                <option value="STRING">STRING</option>
                <option value="DATE">DATE</option>
                <option value="BOOLEAN">BOOLEAN</option>
            </select>
        `;
        columnsDiv.appendChild(newColumnDiv);
    } 
    async function createTable(){
        
        const table_name_value = document.getElementById('table-name').value.trim();
        const columnDivs = document.querySelectorAll('.column-input');
        const columns = [];


        if(!table_name_value){
            alert("Table name is required");
            return;
        }
        for(const colDiv of columnDivs){
            const colName = colDiv.querySelector('input').value.trim();
            const colType = colDiv.querySelector('select').value;
            
            if(!colName){
                alert("All column names are required");
                return;
            }
            columns.push({name: colName, type: colType});
        }
        
        const object={ tableName: table_name_value, columns: columns };
        
        try{
            const response = await axios.post('http://localhost:3000/create-table', object);
          
            alert(response.data.message);
           
            togglefunction(false);
            gettables();
            
            
        
        }catch(error){
            console.error("Error creating table:", error.response ? error.response.data : error);
            alert("error creating table");
    }

}

function gettables(){
    axios.get('http://localhost:3000/get-tables')
    .then(response => {
        const tables = response.data.tables;
        const tableList=document.getElementById('table-list');
    
        tableList.innerHTML = ''; 
        
        for(const table of tables){
            const li=document.createElement('li');
            li.className="fetchedtablename"
            li.textContent=table;
            li.onclick=function(){
                document.getElementById('table-body').innerHTML = ''; 
                showtabledata(table); 
            }
            tableList.appendChild(li);
        }
        
    })
    .catch(error => {
        console.error("Error fetching tables:", error);
    });
}
function showtabledata(tablename){
    axios.get(`http://localhost:3000/get-columns/${tablename}`)
    .then(response => {
        const columns = response.data.columns;
        const tr=document.createElement('tr');
        for(const col of columns){
            const th=document.createElement('th');
            th.className="table-header-value"
            th.textContent=col.name;
            tr.appendChild(th);
        }
        const tableHead=document.getElementById('table-head');
        tableHead.innerHTML="";
        tableHead.appendChild(tr);
        document.getElementById('insert-data-button').style.display = 'block';
        document.getElementById('insert-data-button').onclick = function() {
            showform(true);
            form1.setAttribute('data-table-name', tablename); 
        
        }
          addingdataToTable(tablename); 
    })

    .catch(error => {
        console.error("Error fetching table columns:", error);
    });
}
function showform(show){
    const form = document.getElementById('inserting-data-into-db');
    const form_input_group = document.querySelector('.form_input-group');
    form_input_group.innerHTML = '';
    if(show){
        form.style.display="block";
        document.getElementById('insert-data-button').style.display = 'none';
        document.getElementById('table-colums-display').style.display = 'none';
        const list_of_leaders = document.getElementsByClassName('table-header-value');
        for(const header of list_of_leaders){
            if(header.textContent.toLowerCase() === 'id' || header.textContent.toLowerCase() === 'createdat' || header.textContent.toLowerCase() === 'updatedat') continue; // Skip timestamp fields
            const input_field=document.createElement('input');
            input_field.type="text";
            input_field.name=header.textContent;
            input_field.placeholder=header.textContent;
            form_input_group.appendChild(input_field);
        }
    }else{
        form.style.display="none";  
    }
}
  const form1 = document.getElementById('inserting-data-into-db');
    form1.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputs = form1.querySelectorAll('input');
            const data = {};
            inputs.forEach(input => {
                data[input.name] = input.value;
            });
            console.log(data);
            console.log(form1.getAttribute('data-table-name'));
            
            try {
                const response = await axios.post(`http://localhost:3000/insert-data/${form1.getAttribute('data-table-name')}`, data); // Replace 'your_table_name' with the actual table name
                alert(response.data.message);
                console.log(response.data.data);
                showform(false);
                document.getElementById('table-colums-display').style.display = 'block';
                document.getElementById('insert-data-button').style.display = 'block';
                addingdataToTable(form1.getAttribute('data-table-name'));
               
            } catch (error) {
                console.error("Error inserting data:", error.response ? error.response.data : error);
                alert("Error inserting data");
            }
        });
async function addingdataToTable(tablename){
    console.log(tablename);
    try {
    const response = await axios.get(`http://localhost:3000/fetch-data/${tablename}`);
   const records = response.data.data;

    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = ''; 
        for(const record of records){
            const tr=document.createElement('tr');
            for(const key in record){
                const td=document.createElement('td');
                td.textContent=record[key];
                tr.appendChild(td);
            }
            const button = document.createElement('button');
            button.textContent = 'Delete';
            button.onclick=function(){
                deleteRecord(tablename, record.id);
            }
            tr.appendChild(button)
            tableBody.appendChild(tr);
        }
    } catch (error) {
        console.error("Error fetching table data:", error);
    }   
}
function deleteRecord(tablename, recordId) {
    if (!confirm("Are you sure you want to delete this record?")) {
        return; // User cancelled the deletion
    }

    axios.delete(`http://localhost:3000/delete-record/${tablename}/${recordId}`)
        .then(response => {
            alert(response.data.message);
            addingdataToTable(tablename); 
        })
        .catch(error => {
            console.error("Error deleting record:", error.response ? error.response.data : error);
            alert("Error deleting record");
        });
}
</script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    
</body>
</html>